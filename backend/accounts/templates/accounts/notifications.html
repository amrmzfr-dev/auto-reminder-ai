{% extends 'base.html' %}

{% block title %}Notifications - AutoReminder{% endblock %}

{% block content %}
<div class="min-h-screen ml-16 mt-12 p-8 text-white">
	<div class="flex items-center justify-between mb-6">
		<h1 class="text-2xl font-bold">Notifications</h1>
		<div class="flex items-center space-x-3">
			<!-- Sort By Dropdown -->
			<div class="relative">
				<button id="sort-button" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-xs flex items-center space-x-1">
					<span>Sort by: ðŸ•’ </span>
					<svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
						<path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
					</svg>
				</button>
				<div id="sort-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-700 rounded-md shadow-lg z-50">
					<div class="py-1">
						<button class="sort-option block w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-600" data-sort="latest">
							ðŸ•’ Latest First
						</button>
						<button class="sort-option block w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-600" data-sort="oldest">
							ðŸ•’ Oldest First
						</button>
						<hr class="border-gray-600 my-1">
						<button class="sort-option block w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-600" data-sort="priority-high">
							ðŸ”´ High Priority First
						</button>
						<button class="sort-option block w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-600" data-sort="priority-low">
							ðŸŸ¢ Low Priority First
						</button>
						<hr class="border-gray-600 my-1">
						<button class="sort-option block w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-600" data-sort="unread-first">
							ðŸ“¬ Unread First
						</button>
						<button class="sort-option block w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-600" data-sort="read-first">
							ðŸ“­ Read First
						</button>
					</div>
				</div>
			</div>
			<button id="mark-all" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs">Mark all read</button>
			<button id="clear-all-page" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">Clear all</button>
		</div>
	</div>

	<style>
	/* Ensure proper button layout */
	#notif-list .actions{ display:flex !important; align-items:center !important; gap:0.75rem !important; }
	</style>

	<div id="notif-list" class="bg-gray-800 rounded-xl shadow p-2 divide-y divide-gray-700"></div>
</div>

<script>
const LIST_URL = "{% url 'admin_notifications' %}";
const MARK_ALL_URL = "{% url 'mark_all_notifications_read' %}";
const CLEAR_URL = "{% url 'clear_notifications' %}";
function delUrl(id){ return "{% url 'delete_notification' 0 %}".replace('/0/','/' + id + '/'); }
function markReadUrl(id){ return "{% url 'mark_notification_read' 0 %}".replace('/0/','/' + id + '/'); }

function installationDetailUrl(installationId){
	const template = "{% url 'installation_detail' 'INSTALL_ID_PLACEHOLDER' %}";
	return template.replace('INSTALL_ID_PLACEHOLDER', installationId);
}
function taskDetailUrl(taskId){
	return "{% url 'task_detail' 0 %}".replace('/0/','/' + taskId + '/');
}
const ADMIN_DASHBOARD_URL = "{% url 'admin_dashboard' %}";

async function loadPageNotifs(){
	const res = await fetch(LIST_URL);
	if(!res.ok){ return; }
	const data = await res.json();
	console.log('[Notif] Loaded', data.notifications?.length || 0, 'notifications');
	renderList(data.notifications);
}

function highlightFromHash(){
	const hash = window.location.hash;
	if(!hash || !hash.startsWith('#n-')) return;
	const id = hash.substring(3);
	const el = document.getElementById('n-'+id);
	if(el){
		el.classList.add('ring-2','ring-blue-500');
		el.scrollIntoView({ behavior: 'smooth', block: 'center' });
		setTimeout(()=> el.classList.remove('ring-2','ring-blue-500'), 3000);
	}
}

function goToItem(installationId, taskId, notificationId) {
	fetch(markReadUrl(notificationId), { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
	if (installationId) {
		window.location.href = installationDetailUrl(installationId) + `?highlight=notification-${notificationId}`;
	} else if (taskId) {
		window.location.href = taskDetailUrl(taskId) + `?highlight=notification-${notificationId}`;
	} else {
		window.location.href = ADMIN_DASHBOARD_URL + `?from=notification-${notificationId}`;
	}
}

function renderList(items){
	const container = document.getElementById('notif-list');
	if(!items || items.length===0){
		container.innerHTML = `<div class="p-6 text-center text-gray-400">No notifications</div>`;
		return;
	}
	
	// Apply current sorting
	const sortedItems = sortNotifications(items, currentSortMethod);
	
	container.innerHTML = sortedItems.map(n => `
		<div id="n-${n.id}" class="p-3 flex items-start justify-between ${n.is_read? 'opacity-70':''}">
			<div class="flex-1">
				<p class="text-sm ${n.is_read? 'text-gray-300':'text-white font-semibold'}">${n.message}</p>
				<div class="mt-1 flex items-center gap-2">
					<span class="text-xs text-gray-400">${n.created_at}</span>
					${n.priority ? `
						<span class="text-[10px] px-2 py-0.5 rounded-full ${n.priority==='High' ? 'bg-yellow-600 text-yellow-100' : (n.priority==='Medium' ? 'bg-green-700 text-green-100' : 'bg-gray-600 text-gray-100')}">${n.priority}</span>
					` : ''}
				</div>
			</div>
			<div class="actions">
				<button class="go-to-button text-xs text-white px-3 py-1 rounded hover:bg-blue-600 transition-colors"
					style="background-color:#3b82f6;"
					onclick="goToItem('${n.related_installation || ''}', '${n.related_task || ''}', ${n.id})">
					Go To
				</button>
				${!n.is_read ? `<span class="inline-block h-2 w-2 rounded-full bg-red-400 align-middle"></span>` : ''}
				<button class="text-xs text-white px-3 py-1 rounded hover:bg-red-600 transition-colors" 
					style="background-color:#ef4444;"
					onclick="deleteOne(${n.id})">Delete</button>
			</div>
		</div>
	`).join('');
	highlightFromHash();
}

// Sorting functionality
let currentSortMethod = 'latest'; // Default sort method

function sortNotifications(notifications, sortMethod) {
	const sorted = [...notifications];
	
	// Define priority order outside the switch for both priority cases
	const priorityOrder = { 'High': 3, 'Medium': 2, 'Low': 1 };
	
	switch(sortMethod) {
		case 'latest':
			// Sort by created_at descending (newest first)
			return sorted.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
			
		case 'oldest':
			// Sort by created_at ascending (oldest first)
			return sorted.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
			
		case 'priority-high':
			// Sort by priority: High > Medium > Low
			return sorted.sort((a, b) => {
				const aPriority = priorityOrder[a.priority] || 0;
				const bPriority = priorityOrder[b.priority] || 0;
				return bPriority - aPriority;
			});
			
		case 'priority-low':
			// Sort by priority: Low > Medium > High
			return sorted.sort((a, b) => {
				const aPriority = priorityOrder[a.priority] || 0;
				const bPriority = priorityOrder[b.priority] || 0;
				return aPriority - bPriority;
			});
			
		case 'unread-first':
			// Sort by read status: unread first, then by date
			return sorted.sort((a, b) => {
				if (a.is_read !== b.is_read) {
					return a.is_read ? 1 : -1; // Unread first
				}
				return new Date(b.created_at) - new Date(a.created_at); // Then by date
			});
			
		case 'read-first':
			// Sort by read status: read first, then by date
			return sorted.sort((a, b) => {
				if (a.is_read !== b.is_read) {
					return a.is_read ? -1 : 1; // Read first
				}
				return new Date(b.created_at) - new Date(a.created_at); // Then by date
			});
			
		default:
			return sorted;
	}
}

// Sort dropdown functionality
function initializeSortDropdown() {
	const sortButton = document.getElementById('sort-button');
	const sortDropdown = document.getElementById('sort-dropdown');
	const sortOptions = document.querySelectorAll('.sort-option');
	
	// Toggle dropdown
	sortButton.addEventListener('click', (e) => {
		e.stopPropagation();
		sortDropdown.classList.toggle('hidden');
	});
	
	// Close dropdown when clicking outside
	document.addEventListener('click', () => {
		sortDropdown.classList.add('hidden');
	});
	
	// Handle sort option clicks
	sortOptions.forEach(option => {
		option.addEventListener('click', (e) => {
			e.stopPropagation();
			const sortMethod = option.dataset.sort;
			currentSortMethod = sortMethod;
			
			// Update button text to show current sort
			const sortText = option.textContent.trim();
			sortButton.querySelector('span').textContent = sortText.split(' ')[0]; // Show first word
			
			// Close dropdown
			sortDropdown.classList.add('hidden');
			
			// Re-render with new sorting
			loadPageNotifs();
		});
	});
}

async function deleteOne(id){
	const res = await fetch(delUrl(id), { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
	if(res.ok){ loadPageNotifs(); }
}

document.getElementById('mark-all').addEventListener('click', async ()=>{
	const res = await fetch(MARK_ALL_URL, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
	if(res.ok){ loadPageNotifs(); }
});

document.getElementById('clear-all-page').addEventListener('click', async ()=>{
	const res = await fetch(CLEAR_URL, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
	if(res.ok){ loadPageNotifs(); }
});

function getCookie(name) {
	let cookieValue = null;
	if (document.cookie && document.cookie !== '') {
		const cookies = document.cookie.split(';');
		for (let i = 0; i < cookies.length; i++) {
			const cookie = cookies[i].trim();
			if (cookie.substring(0, name.length + 1) === (name + '=')) {
				cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
				break;
			}
		}
	}
	return cookieValue;
}

document.addEventListener('DOMContentLoaded', ()=>{ 
	loadPageNotifs(); 
	highlightFromHash(); 
	initializeSortDropdown();
});
</script>
{% endblock %} 